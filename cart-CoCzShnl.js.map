{"version":3,"file":"cart-CoCzShnl.js","sources":["src/global/functions/cart.ts"],"sourcesContent":["\nimport { cart, CartData, CartDiscount, easyprotectInsured } from \"../data/cart\";\nimport { jsonfetch, formfetch } from \"./fetch\";\nimport { DataLayer } from \"../dataLayer\";\n\n\nexport async function reloadCart() {\n    update(await fetch(cart.get('api').reload));\n}\n\nexport async function removeProduct(id: string) {\n    const productData = cart.get(\"products\")?.[id];\n    if(productData) DataLayer.removeFromCart(productData);\n\n    const data = await fetch(cart.get('api').productRemove, { \"id\": id });\n\n    if(data) {\n        if(data.products.length == 0)\n            document.location.reload();\n    \n        else ShowMessageFromData(\"Błąd usuwania produktu\", data, async (cleanedData)=>{ \n            update(cleanedData);\n        });\n    }\n    \n    const product = document.querySelector(`ks-cart-product[ikey=\"${id}\"]`) as HTMLKsCartProductElement;\n    if(product) product.ResetLoading();\n}\n\n\nvar productCountAbortController = new AbortController();\n\nexport async function productCount(id: string, count: number) : Promise<number> {\n    let maxCount = null;\n\n    productCountAbortController.abort();\n    productCountAbortController = new AbortController();\n\n    const data = await fetch(cart.get('api').productCount, {\n        \"id\": id,\n        \"ilosc\": count.toString()\n    }, productCountAbortController.signal);\n\n    if(data) {\n        ShowMessageFromData(\"Błąd ilości produktu\", data, async (cleanedData)=>{\n            if('error' in cleanedData) {\n                messagePopup().show(\"Błąd ilości produktu\", cleanedData.error.message);\n                maxCount = (cleanedData?.error?.maxCount as number) ?? null;\n            }\n\n            else update(cleanedData);\n    \n            if('discount' in cleanedData == false)\n                RemoveDiscount();\n        });\n    }\n\n    return maxCount;\n}\n\nexport async function addDeal(id: string) {\n    cart.set(\"loadingDeals\", true);\n    const data = await fetch(cart.get('api').addDeal, {\"id\": id });\n    cart.set(\"loadingDeals\", false);\n\n    if(!data || 'error' in data) {\n        messagePopup().show(\"Błąd dodawania gratisu\", data.error.message);\n        return;\n    }\n    else await update(data);\n}\n\n\n\nexport async function countryChange(code :string) {\n    StartLoading(`ks-cart-select-shipping`);\n    StartLoading(`ks-cart-select-payment`);\n    update(await fetch(cart.get('api').countryChange, { \"data\": code }));\n    ResetLoading(`ks-cart-select-shipping`);\n    ResetLoading(`ks-cart-select-payment`);\n}\n\n\nexport async function shippingChange(id: number) {\n    StartLoading(`ks-cart-select-payment`);\n    update(await fetch(cart.get('api').shippingChange, { \"data\": id.toString() }));\n    ResetLoading(`ks-cart-select-payment`);\n}\n\nexport async function paymentChange(id: number) {\n    update(await fetch(cart.get('api').paymentChange, {\"data\": id.toString() }));\n}\n\nexport async function discountRemove() {\n    update(await fetch(cart.get('api').discountRemove));\n    RemoveDiscount();\n}\n\nfunction RemoveDiscount() {\n    cart.set(\"discount\", {} as CartDiscount);\n}\n\nexport async function discountCodeAdd(code: string) {\n    const data = await fetch(cart.get('api').discountCode, { \"data\": code });\n\n    ShowMessageFromData(\"Błąd dodawania kodu\", data, (pData)=>{\n        update(pData);\n    });\n\n    ResetLoading(`ks-cart-discount-code`);\n}\n\nexport async function discountPointsAdd(points: number) {\n    const data = await fetch(cart.get('api').discountPoints, {\"data\": points.toString() });\n\n    ScrollToElement('ks-cart-discount-container ks-cart-heading');\n    update(data);\n    ResetLoading(`ks-cart-discount-points`);\n};\n\n\nfunction ScrollToElement(querySelector: string) {\n    const heading = document.querySelectorAll(querySelector);\n    let scrollAmount = 0;\n    \n    if(heading.length == 2)\n        scrollAmount = heading[1].getBoundingClientRect().top - heading[0].getBoundingClientRect().top;\n\n    if(scrollAmount)\n        window.scrollBy(0, -scrollAmount);\n}\n\n\nexport async function easyprotectChange(insured: easyprotectInsured) {\n    const api = cart.get(\"api\").easyprotectChange;\n\n    loading();\n    \n    await jsonfetch(api, insured)\n    .then(response => response.json())\n    .then(json => update(json));\n\n    loaded();\n}\n\nexport async function easyprotectRemove(id: string) {\n    const api = cart.get(\"api\").easyprotectRemove;\n\n    loading();\n\n    await formfetch(api, {\"id\": id})\n    .then(response => response.json())\n    .then(json => update(json));\n\n    loaded();\n}\n\n\n\nfunction StartLoading(querySelector: string) {\n    const component = document.querySelector(querySelector) as any;\n    if(component && 'StartLoading' in component)\n        component.StartLoading();\n}\n\nfunction ResetLoading(querySelector: string) {\n    const component = document.querySelector(querySelector) as any;\n    if(component && 'ResetLoading' in component)\n        component.ResetLoading();\n}\n\n\nasync function ShowMessageFromData(name: string, data: any, callback: (d: any)=>void ) {\n    if('message' in data){\n        messagePopup().show(name, data.message);\n        delete data.message;\n\n        // Update state after modal animation finishes.\n        setTimeout(() => {\n            callback(data);\n        }, 200);\n    }\n    else callback(data);\n}\n\n\nasync function fetch(url: string, formProperties?: {[index: string]: string}, signal?: any) {\n    loading();\n\n    return formfetch(url, formProperties, signal)\n    .then(response => response.json())\n    .then(json => {\n        loaded();\n        return json;\n    })\n    .catch(error => {\n        loaded();\n        \n        if (error.name != 'AbortError') {\n            messageError().show(error);\n        }\n\n        return {};\n    });\n}\n\nexport function update(data: any) {\n    Object.keys(data).map(key => {\n        cart.set(key as keyof CartData, data[key]);\n    });\n\n    if('discount' in data == false)\n        RemoveDiscount();\n}\n\nfunction loading() {\n    cart.set(\"loading\", cart.get(\"loading\") + 1);\n}\n\nfunction loaded() {\n    if(cart.get(\"loading\") > 0)\n        cart.set(\"loading\", cart.get(\"loading\") - 1);\n}\n\nfunction messagePopup() {\n    return document.querySelector('ks-message-popup') as HTMLKsMessagePopupElement;\n}\n\nfunction messageError() {\n    return document.querySelector('ks-error-popup') as HTMLKsErrorPopupElement;\n}"],"names":[],"mappings":"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"}