{"version":3,"file":"cart-Dt4F-giP.system.js","sources":["src/global/functions/cart.ts"],"sourcesContent":["\nimport { cart, CartData, CartDiscount, easyprotectInsured } from \"../data/cart\";\nimport { jsonfetch, formfetch } from \"./fetch\";\nimport { DataLayer } from \"../dataLayer\";\n\n\nexport async function reloadCart() {\n    update(await fetch(cart.get('api').reload));\n}\n\nexport async function removeProduct(id: string) {\n    const productData = cart.get(\"products\")?.[id];\n    if(productData) DataLayer.removeFromCart(productData);\n\n    const data = await fetch(cart.get('api').productRemove, { \"id\": id });\n\n    if(data) {\n        if(data.products.length == 0)\n            document.location.reload();\n    \n        else ShowMessageFromData(\"Błąd usuwania produktu\", data, async (cleanedData)=>{ \n            update(cleanedData);\n        });\n    }\n    \n    const product = document.querySelector(`ks-cart-product[ikey=\"${id}\"]`) as HTMLKsCartProductElement;\n    if(product) product.ResetLoading();\n}\n\n\nvar productCountAbortController = new AbortController();\n\nexport async function productCount(id: string, count: number) : Promise<number> {\n    let maxCount = null;\n\n    productCountAbortController.abort();\n    productCountAbortController = new AbortController();\n\n    const data = await fetch(cart.get('api').productCount, {\n        \"id\": id,\n        \"ilosc\": count.toString()\n    }, productCountAbortController.signal);\n\n    if(data) {\n        ShowMessageFromData(\"Błąd ilości produktu\", data, async (cleanedData)=>{\n            if('error' in cleanedData) {\n                messagePopup().show(\"Błąd ilości produktu\", cleanedData.error.message);\n                maxCount = (cleanedData?.error?.maxCount as number) ?? null;\n            }\n\n            else update(cleanedData);\n    \n            if('discount' in cleanedData == false)\n                RemoveDiscount();\n        });\n    }\n\n    return maxCount;\n}\n\nexport async function addDeal(id: string) {\n    cart.set(\"loadingDeals\", true);\n    const data = await fetch(cart.get('api').addDeal, {\"id\": id });\n    cart.set(\"loadingDeals\", false);\n\n    if(!data || 'error' in data) {\n        messagePopup().show(\"Błąd dodawania gratisu\", data.error.message);\n        return;\n    }\n    else await update(data);\n}\n\n\n\nexport async function countryChange(code :string) {\n    StartLoading(`ks-cart-select-shipping`);\n    StartLoading(`ks-cart-select-payment`);\n    update(await fetch(cart.get('api').countryChange, { \"data\": code }));\n    ResetLoading(`ks-cart-select-shipping`);\n    ResetLoading(`ks-cart-select-payment`);\n}\n\n\nexport async function shippingChange(id: number) {\n    StartLoading(`ks-cart-select-payment`);\n    update(await fetch(cart.get('api').shippingChange, { \"data\": id.toString() }));\n    ResetLoading(`ks-cart-select-payment`);\n}\n\nexport async function paymentChange(id: number) {\n    update(await fetch(cart.get('api').paymentChange, {\"data\": id.toString() }));\n}\n\nexport async function discountRemove() {\n    update(await fetch(cart.get('api').discountRemove));\n    RemoveDiscount();\n}\n\nfunction RemoveDiscount() {\n    cart.set(\"discount\", {} as CartDiscount);\n}\n\nexport async function discountCodeAdd(code: string) {\n    const data = await fetch(cart.get('api').discountCode, { \"data\": code });\n\n    ShowMessageFromData(\"Błąd dodawania kodu\", data, (pData)=>{\n        update(pData);\n    });\n\n    ResetLoading(`ks-cart-discount-code`);\n}\n\nexport async function discountPointsAdd(points: number) {\n    const data = await fetch(cart.get('api').discountPoints, {\"data\": points.toString() });\n\n    ScrollToElement('ks-cart-discount-container ks-cart-heading');\n    update(data);\n    ResetLoading(`ks-cart-discount-points`);\n};\n\n\nfunction ScrollToElement(querySelector: string) {\n    const heading = document.querySelectorAll(querySelector);\n    let scrollAmount = 0;\n    \n    if(heading.length == 2)\n        scrollAmount = heading[1].getBoundingClientRect().top - heading[0].getBoundingClientRect().top;\n\n    if(scrollAmount)\n        window.scrollBy(0, -scrollAmount);\n}\n\n\nexport async function easyprotectChange(insured: easyprotectInsured) {\n    const api = cart.get(\"api\").easyprotectChange;\n\n    loading();\n    \n    await jsonfetch(api, insured)\n    .then(response => response.json())\n    .then(json => update(json));\n\n    loaded();\n}\n\nexport async function easyprotectRemove(id: string) {\n    const api = cart.get(\"api\").easyprotectRemove;\n\n    loading();\n\n    await formfetch(api, {\"id\": id})\n    .then(response => response.json())\n    .then(json => update(json));\n\n    loaded();\n}\n\n\n\nfunction StartLoading(querySelector: string) {\n    const component = document.querySelector(querySelector) as any;\n    if(component && 'StartLoading' in component)\n        component.StartLoading();\n}\n\nfunction ResetLoading(querySelector: string) {\n    const component = document.querySelector(querySelector) as any;\n    if(component && 'ResetLoading' in component)\n        component.ResetLoading();\n}\n\n\nasync function ShowMessageFromData(name: string, data: any, callback: (d: any)=>void ) {\n    if('message' in data){\n        messagePopup().show(name, data.message);\n        delete data.message;\n\n        // Update state after modal animation finishes.\n        setTimeout(() => {\n            callback(data);\n        }, 200);\n    }\n    else callback(data);\n}\n\n\nasync function fetch(url: string, formProperties?: {[index: string]: string}, signal?: any) {\n    loading();\n\n    return formfetch(url, formProperties, signal)\n    .then(response => response.json())\n    .then(json => {\n        loaded();\n        return json;\n    })\n    .catch(error => {\n        loaded();\n        \n        if (error.name != 'AbortError') {\n            messageError().show(error);\n        }\n\n        return {};\n    });\n}\n\nexport function update(data: any) {\n    Object.keys(data).map(key => {\n        cart.set(key as keyof CartData, data[key]);\n    });\n\n    if('discount' in data == false)\n        RemoveDiscount();\n}\n\nfunction loading() {\n    cart.set(\"loading\", cart.get(\"loading\") + 1);\n}\n\nfunction loaded() {\n    if(cart.get(\"loading\") > 0)\n        cart.set(\"loading\", cart.get(\"loading\") - 1);\n}\n\nfunction messagePopup() {\n    return document.querySelector('ks-message-popup') as HTMLKsMessagePopupElement;\n}\n\nfunction messageError() {\n    return document.querySelector('ks-error-popup') as HTMLKsErrorPopupElement;\n}"],"names":[],"mappings":"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"}