{"version":3,"names":["async","removeProduct","id","data","ProductLoadingWrapper","fetch","cart","get","productRemove","products","length","document","location","reload","ShowMessageFromData","cleanedData","update","this","RemoveDiscount","product","querySelector","ResetLoading","lastProductCountCall","productCount","count","last","ProductCountCall","then","undefined","current","ilosc","toString","messagePopup","show","error","message","set","GetCorrectedProductAmounts","amount","maxAmount","SetAmount","quantity","maxQuantity","addDeal","key","spinner","countryChange","code","StartLoading","shippingChange","paymentChange","discountRemove","discountCodeAdd","discountCode","pData","discountPointsAdd","points","discountPoints","ScrollToElement","heading","querySelectorAll","scrollAmount","getBoundingClientRect","top","window","scrollBy","easyprotectChange","insured","api","loading","jsonfetch","response","json","loaded","easyprotectRemove","formfetch","component","name","callback","setTimeout","func","output","url","formProperties","catch","messageError","Object","keys","map"],"sources":["src/global/functions/cart.ts"],"sourcesContent":["\nimport { cart, CartData, CartDiscount, easyprotectInsured } from \"../data/cart\";\nimport { jsonfetch, formfetch } from \"./fetch\";\n\n\nexport async function removeProduct(id: string) {\n    const data = await ProductLoadingWrapper(async ()=>{\n        return fetch(cart.get('api').productRemove, { \"id\": id });\n    });\n\n    if(data) {\n        if(data.products.length == 0)\n            document.location.reload();\n    \n        else ShowMessageFromData(\"Błąd usuwania produktu\", data, async (cleanedData)=>{ \n            update(cleanedData);\n\n            if('discount' in cleanedData == false)\n                this.RemoveDiscount();\n        });\n    }\n    \n    const product = document.querySelector(`ks-cart-product[ikey=\"${id}\"]`) as HTMLKsCartProductElement;\n    if(product) product.ResetLoading();\n}\n\n\n\n\n\nvar lastProductCountCall = {};\nexport async function productCount(id: string, count: number, last: number) {\n\n    if (lastProductCountCall[id]) {\n        lastProductCountCall[id] = () => ProductCountCall(id, count, last);\n    }\n        \n    else {\n        lastProductCountCall[id] = ()=>{};\n        ProductCountCall(id, count, last).then(()=>{\n            if(lastProductCountCall[id]) {\n                lastProductCountCall[id]();\n                lastProductCountCall[id] = undefined;\n            }\n        });\n    }\n}\n\nasync function ProductCountCall(id: string, current: number, last: number) {\n    const data = await ProductLoadingWrapper(async ()=>{\n        return fetch(cart.get('api').productCount, {\n            \"id\": id,\n            \"ilosc\": current.toString()\n        });\n    });\n\n    if(data) {\n        ShowMessageFromData(\"Błąd ilości produktu\", data, async (cleanedData)=>{\n            if('error' in cleanedData) {\n                \n                messagePopup().show(\"Błąd ilości produktu\", cleanedData.error.message);\n                cart.set(\"products\", GetCorrectedProductAmounts(id, cleanedData.error.amount, cleanedData.error.maxAmount));\n            }\n            else await update(cleanedData);\n    \n            if('discount' in cleanedData == false)\n                RemoveDiscount();\n        });\n    }\n    else {\n        cart.set(\"products\", GetCorrectedProductAmounts(id, last));\n        this.SetAmount(last, `ks-cart-product[ikey=\"${id}\"] ks-cart-spinner`);\n    }\n}\n\nfunction GetCorrectedProductAmounts(id: string, amount: number, maxAmount?: number) {\n    const products = cart.get(\"products\");\n    products[id].quantity = amount;\n    if(maxAmount) products[id].maxQuantity = maxAmount;\n\n    return products;\n}\n\n/*function GetDataWithoutProducts(data: any) {\n    const dataWithoutProducts = data;\n    delete dataWithoutProducts.products;\n    return dataWithoutProducts;\n}\n\nfunction SetAmount(amount: number, querySelector: string) {\n    console.log(\"test\");\n    const component = document.querySelector(querySelector) as any;\n    if(component && 'SetAmount' in component)\n        component.SetAmount(amount);\n}*/\n\n\n\nexport async function addDeal(id: string) {\n    cart.set(\"loadingDeals\", true);\n    const data = await fetch(cart.get('api').addDeal, {\"id\": id });\n    cart.set(\"loadingDeals\", false);\n\n    if(!data || 'error' in data) {\n        messagePopup().show(\"Błąd dodawania gratisu\", data.error.message);\n        return;\n    }\n    else await update(data);\n    \n    for (const key in cart.get('products')) {\n        const product = cart.get('products')[key];\n        const spinner = document.querySelector(`ks-cart-product[product-id=\"${product.id}\"] ks-cart-spinner`);\n        (spinner as HTMLKsCartSpinnerElement)?.SetAmount(product.quantity);\n    }\n}\n\n\n\nexport async function countryChange(code :string) {\n    StartLoading(`ks-cart-select-shipping`);\n    StartLoading(`ks-cart-select-payment`);\n    update(await fetch(cart.get('api').countryChange, { \"data\": code }));\n    ResetLoading(`ks-cart-select-shipping`);\n    ResetLoading(`ks-cart-select-payment`);\n}\n\n\nexport async function shippingChange(id: number) {\n    StartLoading(`ks-cart-select-payment`);\n    update(await fetch(cart.get('api').shippingChange, { \"data\": id.toString() }));\n    ResetLoading(`ks-cart-select-payment`);\n}\n\nexport async function paymentChange(id: number) {\n    update(await fetch(cart.get('api').paymentChange, {\"data\": id.toString() }));\n}\n\nexport async function discountRemove() {\n    update(await fetch(cart.get('api').discountRemove));\n    RemoveDiscount();\n}\n\nfunction RemoveDiscount() {\n    cart.set(\"discount\", {} as CartDiscount);\n}\n\nexport async function discountCodeAdd(code: string) {\n    const data = await fetch(cart.get('api').discountCode, { \"data\": code });\n\n    ShowMessageFromData(\"Błąd dodawania kodu\", data, (pData)=>{\n        update(pData);\n    });\n\n    ResetLoading(`ks-cart-discount-code`);\n}\n\nexport async function discountPointsAdd(points: number) {\n    const data = await fetch(cart.get('api').discountPoints, {\"data\": points.toString() });\n\n    ScrollToElement('ks-cart-discount-container ks-cart-heading');\n    update(data);\n    ResetLoading(`ks-cart-discount-points`);\n};\n\n\nfunction ScrollToElement(querySelector: string) {\n    const heading = document.querySelectorAll(querySelector);\n    let scrollAmount = 0;\n    \n    if(heading.length == 2)\n        scrollAmount = heading[1].getBoundingClientRect().top - heading[0].getBoundingClientRect().top;\n\n    if(scrollAmount)\n        window.scrollBy(0, -scrollAmount);\n}\n\n\nexport async function easyprotectChange(insured: easyprotectInsured) {\n    const api = cart.get(\"api\").easyprotectChange;\n\n    loading();\n    \n    await jsonfetch(api, insured)\n    .then(response => response.json())\n    .then(json => update(json));\n\n    loaded();\n}\n\nexport async function easyprotectRemove(id: string) {\n    const api = cart.get(\"api\").easyprotectRemove;\n\n    loading();\n\n    await formfetch(api, {\"id\": id})\n    .then(response => response.json())\n    .then(json => update(json));\n\n    loaded();\n}\n\n\n\nfunction StartLoading(querySelector: string) {\n    const component = document.querySelector(querySelector) as any;\n    if(component && 'StartLoading' in component)\n        component.StartLoading();\n}\n\nfunction ResetLoading(querySelector: string) {\n    const component = document.querySelector(querySelector) as any;\n    if(component && 'ResetLoading' in component)\n        component.ResetLoading();\n}\n\n\nasync function ShowMessageFromData(name: string, data: any, callback: (d: any)=>void ) {\n    if('message' in data){\n        messagePopup().show(name, data.message);\n        delete data.message;\n\n        // Update state after modal animation finishes.\n        setTimeout(() => {\n            callback(data);\n        }, 200);\n    }\n    else callback(data);\n}\n\nasync function ProductLoadingWrapper(func: ()=>Promise<any>) {\n    cart.set(\"loadingProducts\", cart.get(\"loadingProducts\") + 1);\n    const output = await func();\n    cart.set(\"loadingProducts\", cart.get(\"loadingProducts\") - 1);\n    return output;\n}\n\n\nasync function fetch(url: string, formProperties?: {[index: string]: string}) {\n    loading();\n\n    return formfetch(url, formProperties)\n    .then(response => response.json())\n    .then(json => {\n        loaded();\n        return json;\n    })\n    .catch(error => {\n        loaded();\n        messageError().show(error);\n        return {};\n    });\n}\n\nexport function update(data: any) {\n    Object.keys(data).map(key => {\n        cart.set(key as keyof CartData, data[key]);\n    });\n}\n\nfunction loading() {\n    cart.set(\"loading\", cart.get(\"loading\") + 1);\n}\n\nfunction loaded() {\n    cart.set(\"loading\", cart.get(\"loading\") - 1);\n}\n\nfunction messagePopup() {\n    return document.querySelector('ks-message-popup') as HTMLKsMessagePopupElement;\n}\n\nfunction messageError() {\n    return document.querySelector('ks-error-popup') as HTMLKsErrorPopupElement;\n}"],"mappings":"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"}